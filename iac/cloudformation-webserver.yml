AWSTemplateFormatVersion: "2010-09-09"
Description: CloudFormation template for General Ledger Checker WebServer (EC2 + Security Group + UserData)

Parameters:
  LatestAmiId:
    Description: The latest Amazon Linux 2 AMI from the Parameter Store
    Type: "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>"
    Default: "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"

  InstanceType:
    Description: WebServer EC2 instance type
    Type: String
    Default: t2.micro
    AllowedValues:
      - t3.micro
      - t2.micro
    ConstraintDescription: must be a valid EC2 instance type.

  MyIP:
    Description: Your IP address in CIDR format (e.g. 203.0.113.1/32). Use /32 to lock it to you.
    Type: String
    MinLength: "9"
    MaxLength: "18"
    Default: 0.0.0.0/0
    AllowedPattern: ^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.

  VpcId:
    Description: VPC where the instance will be launched
    Type: "AWS::EC2::VPC::Id"

  SubnetId:
    Description: Public subnet (must have a route to an Internet Gateway)
    Type: "AWS::EC2::Subnet::Id"

Resources:
  WebServerSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: Allow HTTP + SSH (restricted to MyIP)
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref MyIP
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref MyIP

  WebServer:
    Type: "AWS::EC2::Instance"
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: !Ref InstanceType
      SubnetId: !Ref SubnetId
      SecurityGroupIds:
        - !Ref WebServerSecurityGroup
      Tags:
        - Key: Name
          Value: GeneralLedgerChecker-WebServer
      UserData:
        Fn::Base64: |
          #!/bin/bash
          set -e
          yum update -y
          yum install -y httpd
          systemctl start httpd
          systemctl enable httpd

          cat > /var/www/html/index.html << 'HTML'
          <!DOCTYPE html>
          <html lang="en">
          <head>
          <meta charset="UTF-8">
          <title>General Ledger Checker</title>
          <style>
              body { font-family: Arial, sans-serif; margin: 40px; background: #f7f7f7; }
              h1 { text-align: center; }
              #container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0px 0px 10px rgba(0,0,0,0.1); }
              table { width: 100%; border-collapse: collapse; margin-top: 20px; }
              th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
              th { background: #eee; }
              #issues { margin-top: 20px; padding: 15px; background: #f1f1f1; border-radius: 6px; }
          </style>
          </head>
          <body>
          <div id="container">
              <h1>General Ledger Checker</h1>
              <p>Upload a CSV file containing columns such as Date, Cost Centre, Description, Debit, and Credit.</p>
              <input type="file" id="fileInput" accept=".csv">
              <div id="output"></div>
              <div id="issues"><strong>Issues will appear here.</strong></div>
          </div>

          <script>
          document.getElementById("fileInput").addEventListener("change", function(e) {
              const file = e.target.files[0];
              if (!file) return;

              const reader = new FileReader();
              reader.onload = function(event) {
                  const text = event.target.result;
                  let rawRows = text.split(/\\r?\\n/);
                  let rows = rawRows
                      .map(r => r.split(",").map(c => c.trim().replace(/^\\uFEFF/, "")))
                      .filter(r => !(r.length === 1 && r[0] === "") && r.some(cell => cell !== ""));

                  displayTable(rows);
                  validateLedger(rows);
              };
              reader.readAsText(file);
          });

          function displayTable(rows) {
              let html = "<table>";
              rows.forEach((row, index) => {
                  html += "<tr>";
                  row.forEach(cell => {
                      html += index === 0 ? `<th>${cell}</th>` : `<td>${cell}</td>`;
                  });
                  html += "</tr>";
              });
              html += "</table>";
              document.getElementById("output").innerHTML = html;
          }

          function validateLedger(rows) {
              const issues = [];
              const header = rows[0].map(h => h.trim().replace(/^\\uFEFF/, ""));
              const debitIndex = header.indexOf("Debit");
              const creditIndex = header.indexOf("Credit");

              if (debitIndex === -1 || creditIndex === -1) {
                  document.getElementById("issues").innerHTML =
                      "<p>Error: CSV file does not contain required 'Debit' and 'Credit' columns.</p>";
                  return;
              }

              rows.slice(1).forEach((row, i) => {
                  const rowNum = i + 2;
                  const cleanRow = row.map(c => c.trim());
                  const debit = parseFloat(cleanRow[debitIndex]) || 0;
                  const credit = parseFloat(cleanRow[creditIndex]) || 0;

                  if (cleanRow.some(cell => cell === "")) issues.push(`Row ${rowNum}: Missing value(s).`);
                  if (debit !== credit) issues.push(`Row ${rowNum}: Debit (£${debit}) does not match Credit (£${credit}).`);
                  if (Math.abs(debit) > 10000 || Math.abs(credit) > 10000) issues.push(`Row ${rowNum}: Contains unusually large values.`);
              });

              document.getElementById("issues").innerHTML =
                  issues.length ? issues.map(i => `<p>• ${i}</p>`).join("") : "<p>No issues found.</p>";
          }
          </script>
          </body>
          </html>
          HTML

Outputs:
  WebServerPublicURL:
    Description: URL of the EC2-hosted site
    Value: !Sub "http://${WebServer.PublicDnsName}"
